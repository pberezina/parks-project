---
title: "STAT6730 Project"
subtitle: "Exploring park access data from the Trust for Public Land"
author: "Polina Berezina, Shan Tang"
date: "12/10/2021"
output: 
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE, echo=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, dpi=300) # setting global settings
options(htmltools.dir.version = FALSE) 
# install.packages(c("ggmap", "tidygeocoder", maps", "mapdata", "VIM", "reshape2", "mice"))
library(dplyr)
library(ggplot2)
library(tidyverse)
library(mice)
library(reshape2)
library(VIM)
library(purrr)
library(xaringan)
# for mapping 
library(ggmap)
library(tidygeocoder)
library(maps)
library(mapdata)
```
  
# Introduction
The Trust for Public Land (TPL) tracks green space availability across U.S. using the **ParkScore index** to measures how well cities are meeting their residentsâ€™ need for public parks based on: 
- **park access**: residents% walk to park within 10-min walking 
- **acreage**: median size, parkland% of city area
- **investment**: spending/resident
- **amenities**: basketball hoops, dig park, playground, restroom, etc.
- **equity** distribution of parks according to race and income (2021 only)

### We explore
- Yearly trends
- The relationship between some features and park rankings/scores
- Affect of adjusting for equity in the newest ranking in 2021

---
# Ranking of cities in 2020

```{r map}
raw <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-06-22/parks.csv')

city_locations <- select(raw, city, rank, year) %>% 
  filter(year == 2020, !city %in% c('Honolulu', 'Anchorage')) %>% # so that we show contiguous usa only, for 2020 year
  mutate(address = paste0(city,', USA'))  %>%  # without appending USA, algorithm confuses same-named cities in other countries
  geocode(address, method = 'osm', lat = lat, long = long) # geocode, or find lat long for each city

usa <- map_data("usa")
states <- map_data("state")

# geocode cities 
ggplot() + 
  geom_polygon(data = states, aes(x = long, y = lat, group = group), color="grey", fill="grey99") +
  coord_fixed(1.3) +
  guides(fill=FALSE) +
  geom_point(data=city_locations, aes(x=long, y=lat), size = 1.4,colour = "black") + 
  geom_point(data=city_locations, aes(x=long, y=lat,  color=rank), size=1) +
  scale_colour_gradient2(low ="#fc8d59", mid="#ffffbf", high = "#91cf60", midpoint = 48) +
  theme_void()
```


---
# Data cleaning
- Year as a factor
- Removed % and $ in the data frame, convert variables from string (%) to double (0-1)
- rename the column names

#### Before
```{r cleaning1}
raw$year <- as.factor(raw$year)
original.colnames <- colnames(raw) # save for the 2021 data used later
head(raw[,c(1:3,6,8,10)], 1)   ### show the changes that we made
```

#### After
```{r cleaning2}
library(stringr)
# replace with dplyr?
raw$park_pct_city_data<- as.numeric(str_replace_all(raw$park_pct_city_data, "%", ""))
raw$pct_near_park_data<- as.numeric(str_replace_all(raw$pct_near_park_data, "%", ""))
raw$spend_per_resident_data<- as.numeric(gsub("\\$","",raw$spend_per_resident_data))

raw1<-raw
colnames(raw1)<-c("year","rank","city","med park size","park size score1","park size pct", "park size score2",
                 "park access","park access socre","park investment","park investment score",
                 "basketball","basketball score", "dogpark",  "dogpark score", "playground", "playground score",
                 "rec sr","rec sr socre","restroom", "restroom score" , "splashground",  "splashground score",
                 "amenities score", "total scores", "total%","city dup","park benches")
head(raw1[,c(1:3,6,8,10)], 1)
```

---
## Handling missing data

- More than 30% of data is missing in 6 out of 28 variables, including restroom, splashground and park benches counts. We omit these variables from analysis. 

.center[
```{r remove,fig.width=10,fig.height=6}
aggr(raw1[,12:28], cex.axis=0.65)
raw1 <- select(raw1, -c("city dup", "park benches", "splashground", "splashground score", "restroom score", "restroom"))
```
]

---
## Handling missing data
- Assuming missing at random for others: impute using mice package with PMM Hot Deck method
```{r impute, echo=TRUE}
raw2 <- select(raw, -c(city, rank)) # everything but city and rank - not useful in imputations
imp <- mice(raw2, method="pmm", donors=5, print=FALSE) 
df <- complete(imp, 1) %>% mutate(., city = raw$city, rank = raw$rank, .after=1) # append back city and rank vars
```

---
## Exploratory data analysis

#### The distribution of variables
.center[
```{r explore1, fig.width=10,fig.height=6}
#basic histogram
df1<-df
colnames(df1)<-c("year","city","rank","med park size","park size score1","park size pct", "park size score2",
                 "park access","park access socre","park investment","park investment score",
                 "basketball","basketball score", "dogpark",  "dogpark score", "playground", "playground score",
                 "rec sr","rec sr socre","restroom", "restroom score" , "splashground",  "splashground score",
                 "amenities score", "total scores", "total%","city dup","park benches")
melt(df1) %>% 
  ggplot(.,aes(x = value)) +  ##,mapping = aes(value, after_stat(density))
      facet_wrap(~variable,scales = "free_x") + 
      geom_histogram() +    #geom_histogram() + # geom_boxplot()  stat_bin(binwidth = h_sturges)
    theme_classic() +
    theme(strip.text.x = element_text(size = 11), text = element_text(size = 9), axis.text.x = element_text(angle=90)) 
```
]


---
#### Variables over the years
```{r, include=FALSE}
##TODO: fix titles - cut off. Axis labels too small. Use 2021 colnames as titles?  >> solved by renaming and figure width adjustment
##TODO: X axis (years) is cut off >> solved by figure hight adjustment
##TODO: maybe color outliers or add any pop of color? 
##TODO: why points e.g. basketball points increase? Answer it on another slide with dplyr or another plot. >> different max. scores, will answer it inn the scores  vs. features plots
```

Increasing trend in the scores of `park size`, `Spending per resident` and `% of residents within a 10-minute walk to park`.

.center[
```{r explore2, fig.width=10,fig.height=6}
# boxplots per year for every varaible
melt(df1) %>% 
  ggplot(.) + 
    facet_wrap(~variable, scales = "free_y") + 
    geom_boxplot(aes(y=value, x=year, group = year)) +
  theme_classic() +
  theme(strip.text.x = element_text(size = 11),text = element_text(size = 9), axis.text.x = element_text(angle=90)) 
```
]

---
## Park Scores vs. Features 
.center[
```{r, fig.width=10,fig.height=6}
library(ggpubr)
##use function to reduce copy and past
plot_trend<-function(df_sub, labsname){
  ##labsname = c(title, xlab, ylab)
  pp<- ggplot( df_sub, aes_string(x=names(df_sub)[1], y=names(df_sub)[2], color=names(df_sub)[3]) )+ 
    geom_point(alpha=0.6)+
    labs(title=labsname[1], x=labsname[2], y=labsname[3])+
    theme_classic() +
    theme(text = element_text(size = 9))
    
  return(pp)
}

p1<- df %>% 
  select(med_park_size_data,med_park_size_points,year) %>% 
  plot_trend (labsname=c("Size Score 1 VS. Median Park Size", "Median Park Size (Acres)", "Score") )

p2<-df %>% 
  select(park_pct_city_data,park_pct_city_points,year) %>% 
  plot_trend (labsname=c("Size Score 2 VS. % Park Size", "Park Size (% city area) ", "Score") ) 
  
p3<- df %>% 
  select(pct_near_park_data,pct_near_park_points,year) %>% 
  plot_trend (labsname=c("Access Score VS. Accessibility", "Residents% within 10-min Walking", "Score") )
  
p4<- df %>% 
  select(spend_per_resident_data,spend_per_resident_points,year) %>% 
  plot_trend (labsname=c("Cost Score VS. Investment", "Cost per resident ($)", "Score") )

ggarrange(p1, p2, p3, p4,
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend="bottom")
```
]

- Different max. scores or score weight across years.
- Increasing trend in score with larger park size, easier accessibility and higher investment in parks

---
## Park Scores vs. Features
- Amenities: (number of)basketball hoops, dog parks, playgrounds
```{r, echo=TRUE}
p1<- df %>% 
  select(basketball_data,basketball_points,year) %>% 
  plot_trend (labsname=c("Basketball Hoops", " ", "Score") )
```
.center[
```{r, fig.width=10,fig.height=4}
p1<- df %>% 
  select(basketball_data,basketball_points,year) %>% 
  plot_trend (labsname=c("Basketball Hoops", " ", "Score") )

p2<-df %>% 
  select(dogpark_data,dogpark_points,year) %>% 
  plot_trend (labsname=c("Dog Parks", " ", "Score") ) 
  
p3<- df %>% 
  select(playground_data,playground_points,year) %>% 
  plot_trend (labsname=c("Playgrounds", " ", "Score") )

ggarrange(p1, p2, p3, 
          ncol = 3, nrow = 1,
          common.legend = TRUE, legend="bottom")
```
]

- Overall increasing trend in score with better amenities

---
## Top ranking cities across years

Pick 2015 vs. 2020 for years and top10 most populated cities on Y axis? 
```{r, fig.width=10,fig.height=6}
city_name<-union(df$city[df$rank<=10 & df$year==2015], df$city[df$rank<=10 & df$year==2020])  ## city
city_name<-city_name[city_name %in% c("Arlington, Virginia","Minneapolis","Irvine") ==FALSE]
ggplot(subset(df, city %in% city_name & year %in% c(2015, 2020)),
       aes(x=rank, y=city)) +
    geom_point(aes(color=year),size=3.5)+
    geom_hline(yintercept=c(1:12), linetype="dashed")+
    labs(x="Park rank", y="City")+
    theme_classic() +
    theme(text = element_text(size = 13))
```


---
## Exploring equity in 2021
TODO: finish

```{r equity}
#df.2021 <- read.csv('parks_2021.csv')
#colnames(df.2021)
#original.colnames
```


---
## Summary & Thank you
- Pay attention to the different scores range/weight across the years
- Parks tend to have greater score with larger park size, easier accessibility, higher investment and more facilities. 

##### Find this project at GitHub: https://github.com/pberezina/parks-project
